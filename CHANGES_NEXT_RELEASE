Code refactoring and performance improvements
