Code refactoring and increase test coverage